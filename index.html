<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miraç AI - Geliştirilmiş Arayüz</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Dark Mode Yapılandırması -->
    <script>
        tailwind.config = {
            darkMode: 'class', // 'class' stratejisini etkinleştirir
        }
    </script>
    
    <!-- React ve ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone (Hatalı URL Düzeltildi) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Ana sayfa arka planı ve font yumuşatma */
        html, body {
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Özel animasyonlar ve kaydırma çubuğu stilleri */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
        }
        .dark .chat-window::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* dark:gray-600 */
        }
    </style>
</head>
<body class="font-sans">

    <!-- React uygulamasının bağlanacağı kök element -->
    <div id="root" class="h-full"></div>

    <!-- Tüm React Kodu -->
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Bileşenler ---

        const ChatHeader = ({ theme, onToggleTheme }) => {
            return (
                <header className="relative flex-shrink-0 flex items-center justify-center bg-gray-100 dark:bg-gray-900/50 p-4 text-center border-b border-gray-200 dark:border-gray-700">
                    <div>
                        <h1 className="text-xl font-bold text-gray-900 dark:text-white">Miraç AI</h1>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Geliştirilmiş Arayüz</p>
                    </div>
                    <button
                        onClick={onToggleTheme}
                        className="absolute right-4 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                        aria-label="Temayı Değiştir"
                    >
                        {theme === 'dark' ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        ) : (
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        )}
                    </button>
                </header>
            );
        };

        const Message = ({ sender, text }) => {
            const isUser = sender === 'user';
            return (
                <div className={`flex items-start gap-3 fade-in ${isUser ? 'flex-row-reverse' : ''}`}>
                    <div className="w-9 h-9 rounded-full bg-gray-200 dark:bg-gray-700 flex justify-center items-center font-bold flex-shrink-0 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200">
                        {isUser ? 'S' : 'M'}
                    </div>
                    <div className={`max-w-[80%] p-3 px-4 rounded-2xl leading-relaxed break-words shadow-md ${isUser ? 'bg-blue-600 text-white rounded-br-lg' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-lg'}`}>
                        {text}
                    </div>
                </div>
            );
        };

        const TypingIndicator = () => (
            <div className="flex p-3 items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex justify-center items-center font-bold flex-shrink-0 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200">M</div>
                <div className="bg-gray-200 dark:bg-gray-700 p-3 px-4 rounded-2xl rounded-bl-lg">
                    <span className="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full inline-block animate-bounce" style={{animationDelay: '0ms'}}></span>
                    <span className="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full inline-block animate-bounce" style={{animationDelay: '150ms'}}></span>
                    <span className="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full inline-block animate-bounce" style={{animationDelay: '300ms'}}></span>
                </div>
            </div>
        );

        const ChatForm = ({ onSendMessage, isLoading }) => {
            const [message, setMessage] = useState('');
            const inputRef = useRef(null);
            
            useEffect(() => { inputRef.current.focus(); }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (message.trim() && !isLoading) {
                    onSendMessage(message);
                    setMessage('');
                }
            };

            return (
                <form onSubmit={handleSubmit} className="flex p-4 gap-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                    <input
                        ref={inputRef}
                        type="text"
                        value={message}
                        onChange={(e) => setMessage(e.target.value)}
                        placeholder="Bir mesaj yazın..."
                        autoComplete="off"
                        required
                        disabled={isLoading}
                        className="flex-grow p-3 px-5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 disabled:opacity-50"
                    />
                    <button
                        type="submit"
                        disabled={isLoading}
                        className="p-3 w-12 h-12 flex items-center justify-center rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200 disabled:bg-blue-800 disabled:cursor-not-allowed"
                        aria-label="Gönder"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            );
        };

        // --- Ana Uygulama Bileşeni ---
        function App() {
            const [messages, setMessages] = useState([
                { sender: 'ai', text: 'Merhaba! Ben Miraç AI. Size nasıl yardımcı olabilirim?' }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const [theme, setTheme] = useState('dark');
            const chatWindowRef = useRef(null);

            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.body.className = 'bg-gray-900 font-sans';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.className = 'bg-gray-100 font-sans';
                }
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prevTheme => (prevTheme === 'dark' ? 'light' : 'dark'));
            };

            const scrollToBottom = () => {
                chatWindowRef.current?.scrollTo({ top: chatWindowRef.current.scrollHeight, behavior: 'smooth' });
            };
            useEffect(scrollToBottom, [messages]);

            const handleSendMessage = async (userMessage) => {
                const newMessages = [...messages, { sender: 'user', text: userMessage }];
                setMessages(newMessages);
                setIsLoading(true);

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: userMessage, 
                            history: newMessages.map(m => ({ role: m.sender, content: m.text })) 
                        }),
                    });
                    if (!response.ok) throw new Error('Sunucu hatası veya geçersiz yanıt.');
                    const data = await response.json();
                    setMessages(prevMessages => [...prevMessages, { sender: 'ai', text: data.response }]);
                } catch (error) {
                    console.error('API çağrısı başarısız:', error);
                    setMessages(prevMessages => [...prevMessages, { sender: 'ai', text: 'Üzgünüm, bir sorun oluştu. Lütfen daha sonra tekrar deneyin.' }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="w-full h-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 flex flex-col sm:max-w-3xl sm:mx-auto sm:my-8 sm:rounded-2xl shadow-2xl overflow-hidden">
                    <ChatHeader theme={theme} onToggleTheme={toggleTheme} />
                    <main ref={chatWindowRef} className="flex-grow p-6 space-y-4 overflow-y-auto chat-window">
                        {messages.map((msg, index) => <Message key={index} sender={msg.sender} text={msg.text} />)}
                        {isLoading && <TypingIndicator />}
                    </main>
                    <div className="flex-shrink-0">
                        <ChatForm onSendMessage={handleSendMessage} isLoading={isLoading} />
                    </div>
                </div>
            );
        }

        // --- Uygulamayı DOM'a Monte Etme ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

